# @Author: Kevin Dai
# @Date:   2017-07-29T14:29:31-04:00
# @Email:  kevindai02@outlook.com
# @Filename: Makefile.in
# @Last modified by:   Kevin Dai
# @Last modified time: 2017-11-22T22:07:24-05:00



CC=@PLATFORM_PREFIX@gcc
AS=@PLATFORM_PREFIX@as

CFLAGS=@PLATFORM_FLAGS@
AFLAGS=@PLATFORM_SFLAGS@
NFLAGS=@PLATFORM_NFLAGS@

TARGET_FOLDER=@PLATFORM_ID@

ODIR=../obj/
BDIR=../bin/

SOURCES := $(shell find -name '*.c' -not -path "*arch/*")
SOURCES := $(SOURCES:./%=%)
SOURCES += $(shell find "arch/"$(TARGET_FOLDER) -name '*.c')

ASOURCES := $(shell find -name '*.s' -not -path "*arch/*")
ASOURCES := $(ASOURCES:./%=%)
ASOURCES += $(shell find "arch/"$(TARGET_FOLDER) -name '*.s')

NSOURCES := $(shell find -name '*.asm' -not -path "*arch/*")
NSOURCES := $(NSOURCES:./%=%)
NSOURCES += $(shell find "arch/"$(TARGET_FOLDER) -name '*.asm')

TSOURCES := $(shell find "../tests/kernel" -name '*.c')
TSOURCES := $(TSOURCES:./%=%)

.PHONY: all
all:
	@echo "\n\033[1;36m[Building C and C++ sources]\033[0m"
	@$(foreach src0,$(SOURCES), echo "\033[1;32mBuilding [$(src0)] \033[0m"; $(CC) -c $(src0) -o $(ODIR)$(subst /,_,$(src0:%.c=%.o)) $(CFLAGS);)

	@echo "\n\033[1;36m[Building assembly sources]\033[0m"
	@$(foreach src1,$(ASOURCES), echo "\033[1;32mBuilding [$(src1)] \033[0m"; $(AS) $(src1) -o $(ODIR)$(subst /,_,$(src1:%.s=%.o)) $(AFLAGS);)
	@$(foreach src2,$(NSOURCES), echo "\033[1;32mBuilding [$(src2)] \033[0m"; nasm -felf $(src2) -o $(ODIR)$(subst /,_,$(src2:%.asm=%.o)) -w-number-overflow;)
	@echo "\n\033[1;36m[Building unit tests]\033[0m"
	@$(foreach src3,$(TSOURCES), echo "\033[1;32mBuilding [$(src3)] \033[0m"; $(CC) -c $(src3) -o $(ODIR)$(subst ..,,$(subst /,_,$(src3:%.c=%.o))) $(CFLAGS);)

.PHONY: noecho
noecho:
	@$(foreach src0,$(SOURCES), $(CC) -c $(src0) -o $(ODIR)$(subst /,_,$(src0:%.c=%.o)) $(CFLAGS);)
	@$(foreach src1,$(ASOURCES), $(AS) $(src1) -o $(ODIR)$(subst /,_,$(src1:%.s=%.o)) $(AFLAGS);)
	@$(foreach src2,$(NSOURCES), nasm -felf $(src2) -o $(ODIR)$(subst /,_,$(src2:%.asm=%.o)) -w-number-overflow $(NFLAGS);)
	@$(foreach src3,$(TSOURCES), $(CC) -c $(src3) -o $(ODIR)$(subst ..,,$(subst /,_,$(src3:%.c=%.o))) $(CFLAGS);)

.PHONY: clean
clean:
	@echo "\033[1;36m[Cleaning all object files]\033[0m"
	@echo -n "\033[1;32mFiles deleted: "
	@rm -rvif $(ODIR)*.o | wc -l
	@echo "\033[0m"

	@echo "\033[1;36m[Removing directories]\033[0m"
	@rm -rf ../isodir
	@echo "\033[1;36m[Removing binaries]\033[0m"
	@rm -rf $(BDIR)*.bin $(BDIR)*.iso $(BDIR)*.img a.out
